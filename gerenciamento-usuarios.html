<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="js/config.js"></script>

    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script> 
    <script src="js/layout.js"></script> <script src="js/gerenciamento-usuarios.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            
            const adminContent = document.getElementById('admin-content');
            const accessDeniedMessage = document.getElementById('access-denied-message');

            // 1. (NOVO) Aguarda a autenticação e o carregamento do perfil
            // A função 'requerAutenticacao' agora é a principal e é assíncrona
            try {
                await window.sistemaAuth.requerAutenticacao();
            } catch (error) {
                // Se falhar (ex: perfil não existe), o 'requerAutenticacao' já redirecionou
                return; 
            }
            
            // 2. (NOVO) Agora, verifica se é admin (de forma síncrona)
            // 'isAdmin()' só funciona DEPOIS que 'requerAutenticacao' terminou
            if (window.sistemaAuth.isAdmin()) {
                adminContent.style.display = 'block';
                accessDeniedMessage.style.display = 'none';
            } else {
                adminContent.style.display = 'none';
                accessDeniedMessage.style.display = 'block';
            }

            // 3. Funcionalidade das abas
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                });
            });

            // 4. Funcionalidade do modal
            const modal = document.getElementById('modal-editar');
            const closeBtn = document.querySelector('.close');
            const fecharModalBtn = document.getElementById('fechar-modal');

            // (As funções openModal e closeModal são definidas no js/gerenciamento-usuarios.js)
            if (closeBtn) closeBtn.addEventListener('click', () => window.fecharModal());
            if (fecharModalBtn) fecharModalBtn.addEventListener('click', () => window.fecharModal());

            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    window.fecharModal();
                }
            });
        });
    </script>
</body>
</html>